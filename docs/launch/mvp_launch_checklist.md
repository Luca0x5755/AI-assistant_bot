# AVATAR - MVP 輕量上線檢查清單

> Version: 1.0.0
> Date: 2025-11-01
> Status: Template (待執行)
> Owner(s): Lead Engineer, SRE
> Target Launch Date: 2025-12-01

---

## 📋 檢查清單總覽

| 類別 | 必要項目數 | 完成數 | 狀態 |
|:---|:---|:---|:---|
| 🔧 功能完整性 | 8 | 0 | ⏳ 待開始 |
| ⚡ 性能達標 | 5 | 0 | ⏳ 待開始 |
| 🔒 安全基線 | 6 | 0 | ⏳ 待開始 |
| 💾 備份與恢復 | 4 | 0 | ⏳ 待開始 |
| 📊 監控與告警 | 5 | 0 | ⏳ 待開始 |
| 📖 運維準備 | 4 | 0 | ⏳ 待開始 |
| **總計** | **32** | **0** | **0%** |

---

## 🔧 功能完整性（Function Completeness）

### 核心流程

- [ ] **語音輸入完整流程**
  - [ ] 麥克風權限請求正常
  - [ ] 語音錄製與傳輸無卡頓
  - [ ] Whisper 轉錄準確率可接受（CER < 10%）
  - [ ] 轉錄延遲 < 600ms

- [ ] **LLM 對話生成**
  - [ ] vLLM 服務正常啟動
  - [ ] TTFT P95 < 800ms
  - [ ] 流式輸出正常顯示
  - [ ] 多輪對話上下文正確

- [ ] **語音輸出**
  - [ ] Fast TTS 合成延遲 P50 < 1.5s
  - [ ] HQ TTS 按需載入成功
  - [ ] 音頻播放流暢無斷續
  - [ ] 快/美雙檔切換正常

### 聲紋管理

- [ ] **聲音上傳**
  - [ ] 支援 WAV/MP3 格式
  - [ ] 上傳進度顯示正常
  - [ ] Embedding 提取成功
  - [ ] 檔案存儲至正確路徑

- [ ] **聲紋使用**
  - [ ] 聲紋列表正確顯示
  - [ ] 選擇聲紋後 TTS 生效
  - [ ] 試聽功能可用
  - [ ] 刪除功能正常

### 對話歷史

- [ ] **歷史查詢**
  - [ ] 對話記錄正確存儲
  - [ ] 歷史列表分頁正常
  - [ ] 重播音頻功能可用
  - [ ] 時間排序正確

### API 端點

- [ ] **所有 API 端點正常**
  - [ ] `GET /health` 返回正確狀態
  - [ ] `POST /api/voice-profile` 正常
  - [ ] `GET /api/voice-profiles` 正常
  - [ ] `DELETE /api/voice-profile/{id}` 正常
  - [ ] `GET /api/conversations` 正常

---

## ⚡ 性能達標（Performance）

### 延遲指標

- [ ] **E2E 延遲達標**
  - [ ] P50 < 2.5s（50 字回應）
  - [ ] P95 < 3.5s（50 字回應）
  - [ ] 測試場景: 至少 100 次請求
  - [ ] 測試數據: 已記錄至日誌

- [ ] **LLM 性能達標**
  - [ ] TTFT P95 < 800ms
  - [ ] Tokens/s > 50
  - [ ] vLLM 日誌無異常

- [ ] **TTS 性能達標**
  - [ ] Fast TTS P50 < 1.5s
  - [ ] HQ TTS 載入 < 10s
  - [ ] 音頻品質主觀評分 ≥ 7/10

### 並發與穩定性

- [ ] **並發測試通過**
  - [ ] 3 並發穩定運行 30 分鐘
  - [ ] 5 並發穩定運行 30 分鐘
  - [ ] VRAM 使用率 < 90%
  - [ ] 無 OOM 錯誤

- [ ] **長時間穩定性**
  - [ ] 連續運行 2 小時無崩潰
  - [ ] 5 並發 2 小時壓測通過
  - [ ] 記憶體無洩漏（RSS 穩定）
  - [ ] 日誌檔案大小可控（< 1GB/天）

---

## 🔒 安全基線（Security Baseline）

### Secrets 管理

- [ ] **敏感資訊隔離**
  - [ ] 所有密碼/Token 已從程式碼移除
  - [ ] 使用 `.env` 或環境變數管理
  - [ ] `.env` 已加入 `.gitignore`
  - [ ] 無 API Key 硬編碼

### 輸入驗證

- [ ] **API 輸入驗證**
  - [ ] 音檔大小限制（< 10MB）
  - [ ] 音檔格式白名單（WAV/MP3）
  - [ ] 文本長度限制（< 1000 字）
  - [ ] SQL 注入防護（使用參數化查詢）

### 網路安全

- [ ] **連線安全**
  - [ ] WebSocket 使用 WSS（生產環境）
  - [ ] CORS 設定正確
  - [ ] Rate Limiting 啟用（10 req/min）
  - [ ] 無已知漏洞依賴（`pip audit`）

---

## 💾 備份與恢復（Backup & Recovery）

### 資料備份

- [ ] **SQLite 備份**
  - [ ] 自動備份腳本就緒
  - [ ] 每日備份已啟用
  - [ ] 備份檔案路徑: `backups/db/`
  - [ ] 備份保留策略: 7 天

- [ ] **音檔備份**
  - [ ] 音檔備份腳本就緒
  - [ ] 每日備份至外部存儲
  - [ ] 備份保留策略: 30 天
  - [ ] 備份壓縮啟用（節省空間）

### 恢復演練

- [ ] **恢復測試**
  - [ ] SQLite 恢復測試成功
  - [ ] 音檔恢復測試成功
  - [ ] 恢復時間 < 10 分鐘
  - [ ] 恢復 Runbook 已文檔化

### 容錯機制

- [ ] **錯誤處理**
  - [ ] WebSocket 斷線自動重連
  - [ ] VRAM 不足降級至 Fast TTS
  - [ ] 模型載入失敗有 fallback
  - [ ] 關鍵錯誤有日誌記錄

---

## 📊 監控與告警（Monitoring & Alerting）

### 健康檢查

- [ ] **健康端點**
  - [ ] `/health` 端點正常
  - [ ] 返回 vLLM/Whisper/TTS 狀態
  - [ ] VRAM 使用率顯示
  - [ ] 並發會話數顯示

### 日誌

- [ ] **結構化日誌**
  - [ ] 使用 JSON 格式
  - [ ] 包含 `trace_id`（追蹤性）
  - [ ] 包含 `level`（INFO/WARN/ERROR）
  - [ ] 關鍵操作有日誌記錄

- [ ] **日誌管理**
  - [ ] 日誌檔案輪轉啟用
  - [ ] 保留策略: 7 天
  - [ ] 錯誤日誌分離（`error.log`）
  - [ ] 日誌路徑: `logs/`

### 指標監控

- [ ] **關鍵指標記錄**
  - [ ] E2E 延遲已記錄
  - [ ] VRAM 使用率已記錄
  - [ ] 並發會話數已記錄
  - [ ] 錯誤率已記錄

### 告警（簡易版）

- [ ] **基本告警**
  - [ ] VRAM > 90% 告警（日誌）
  - [ ] 錯誤率 > 5% 告警（日誌）
  - [ ] 服務停止告警（healthcheck）
  - [ ] 磁碟空間 < 10GB 告警

---

## 📖 運維準備（Operations Readiness）

### 部署文檔

- [ ] **部署 Runbook**
  - [ ] 環境準備步驟完整
  - [ ] 依賴安裝指令清晰
  - [ ] 模型下載步驟明確
  - [ ] 啟動/停止指令清楚

- [ ] **配置文檔**
  - [ ] 環境變數說明完整
  - [ ] 配置檔案範例提供
  - [ ] 資料庫初始化腳本就緒
  - [ ] 目錄權限設定說明

### 回滾計畫

- [ ] **回滾準備**
  - [ ] 前一版本備份保留
  - [ ] 回滾步驟已文檔化
  - [ ] 回滾測試已演練
  - [ ] 預計回滾時間 < 10 分鐘

### 問題排查

- [ ] **Troubleshooting 指南**
  - [ ] 常見錯誤與解決方案
  - [ ] 日誌查看指令
  - [ ] VRAM 監控指令（`nvidia-smi`）
  - [ ] 緊急聯絡人清單

### 容量規劃

- [ ] **資源評估**
  - [ ] VRAM 使用趨勢已記錄
  - [ ] 磁碟使用趨勢已記錄
  - [ ] 並發上限已確認（3-5 會話）
  - [ ] 擴容條件已定義

---

## 🎯 Go/No-Go 決策標準

### 必要條件（任一未達即 No-Go）

- [ ] **功能完整性 ≥ 90%**
- [ ] **性能達標 100%**
- [ ] **安全基線 100%**
- [ ] **備份與恢復 100%**
- [ ] **運維準備 ≥ 90%**

### 可容忍條件（可上線後修正）

- [ ] 監控與告警 ≥ 80%（簡易版可接受）
- [ ] 日誌完整性 ≥ 80%（關鍵操作已覆蓋）

### 風險評估

| 風險 | 嚴重性 | 緩解狀態 | 決策 |
|:---|:---|:---|:---|
| VRAM OOM | 🔴 高 | ✅ 已緩解（限流+降級） | ✅ 可上線 |
| HQ-TTS 載入慢 | 🟡 中 | ✅ 已緩解（預熱+通知） | ✅ 可上線 |
| 台式口音誤字 | 🟡 中 | ⚠️ 部分緩解（UI 可編輯） | ✅ 可上線 |
| 並發過載 | 🟡 中 | ✅ 已緩解（限流） | ✅ 可上線 |

---

## 📝 上線簽核

### 檢查清單完成度

```
總完成度: 0/32 (0%)

- 功能完整性: 0/8 (0%)
- 性能達標:   0/5 (0%)
- 安全基線:   0/6 (0%)
- 備份恢復:   0/4 (0%)
- 監控告警:   0/5 (0%)
- 運維準備:   0/4 (0%)

狀態: ⏳ 待開始開發
```

### 簽核記錄

| 角色 | 姓名 | 簽核狀態 | 日期 | 備註 |
|:---|:---|:---|:---|:---|
| Lead Engineer | - | ⏳ 待簽 | - | 技術可行性確認 |
| SRE | - | ⏳ 待簽 | - | 運維準備度確認 |
| PM | - | ⏳ 待簽 | - | 產品驗收確認 |

---

## 🚀 上線後監控計畫

### 第一週監控重點

- [ ] 每日檢查 `/health` 狀態
- [ ] 每日檢查錯誤日誌
- [ ] 每日檢查 VRAM 使用率
- [ ] 每日檢查磁碟空間

### 第一個月監控重點

- [ ] 每週檢查性能指標趨勢
- [ ] 每週檢查用戶反饋
- [ ] 每週檢查備份完整性
- [ ] 每週評估是否需要擴容

### 升級評估觸發條件

若出現以下情況，需升級至「完整流程」：
- [ ] 並發需求 > 10 會話
- [ ] 需要多用戶系統
- [ ] 需要跨區域部署
- [ ] 需要 SLA 保證

---

## 🔄 檢查清單使用說明

### 執行時機
1. **Week 4 Day 1**: 開始執行檢查清單
2. **Week 4 Day 5**: 完成所有必要項目
3. **Launch Day**: 再次確認所有項目

### 執行方式
1. 逐項檢查，勾選完成項目
2. 記錄未完成項目的原因
3. 評估風險是否可接受
4. 達到 Go/No-Go 標準後進行簽核

### 文檔維護
- 每次檢查後更新完成度
- 記錄發現的問題與解決方案
- 上線後保留此文檔作為歷史記錄

---

## 附錄 A：快速部署檢查

```bash
# 1. 環境檢查
python --version  # ≥ 3.11
nvidia-smi        # RTX 4090 24GB
df -h             # 可用空間 > 100GB

# 2. 服務檢查
curl http://localhost:8000/health
# 預期: {"status": "healthy", "models": {...}}

# 3. 壓測檢查
python scripts/stress_test.py --concurrent 5 --duration 120
# 預期: 無 OOM，P95 < 3.5s

# 4. 備份檢查
ls -lh backups/db/
ls -lh backups/audio/
# 預期: 最新備份在 24 小時內
```

---

## 附錄 B：緊急回滾步驟

```bash
# 1. 停止服務
pkill -f "uvicorn app.main:app"

# 2. 恢復資料庫
cp backups/db/latest.db app.db

# 3. 恢復音檔（如需要）
rsync -av backups/audio/ audio/

# 4. 回滾程式碼
git checkout <previous-version>

# 5. 重啟服務
uvicorn app.main:app --host 0.0.0.0 --port 8000

# 預計時間: < 10 分鐘
```

---

**最後更新**: 2025-11-01
**下次檢查**: 2025-11-28（Week 4 開始）
